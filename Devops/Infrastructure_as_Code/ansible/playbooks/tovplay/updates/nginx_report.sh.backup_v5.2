#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# NGINX AUDIT v5.2 [FIXED] - Direct sshpass Edition
# ═══════════════════════════════════════════════════════════════════════════════

SCRIPT_START=$(date +%s)

PROD_HOST="193.181.213.220"; PROD_USER="admin"; PROD_PASS="EbTyNkfJG6LM"
STAGING_HOST="92.113.144.59"; STAGING_USER="admin"; STAGING_PASS="3897ysdkjhHH"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'
CYAN='\033[0;36m'; MAGENTA='\033[0;35m'; BOLD='\033[1m'; NC='\033[0m'

declare -a CRITICAL_ISSUES=() HIGH_ISSUES=() MEDIUM_ISSUES=() LOW_ISSUES=()
SCORE=100

ssh_prod() {
    local timeout_val="${2:-30}"
    local retries=5
    local result="" rc=1
    for i in $(seq 1 $retries); do
        result=$(sshpass -p "$PROD_PASS" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout="$timeout_val" -o ServerAliveInterval=15 -o ServerAliveCountMax=5 \
             \
            "$PROD_USER@$PROD_HOST" "$1" 2>/dev/null) && rc=0 && break
        sleep 2
    done
    [ $rc -eq 0 ] && echo "$result"
}

ssh_staging() {
    local timeout_val="${2:-30}"
    local retries=5
    local result="" rc=1
    for i in $(seq 1 $retries); do
        result=$(sshpass -p "$STAGING_PASS" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout="$timeout_val" -o ServerAliveInterval=15 -o ServerAliveCountMax=5 \
             \
            "$STAGING_USER@$STAGING_HOST" "$1" 2>/dev/null) && rc=0 && break
        sleep 2
    done
    [ $rc -eq 0 ] && echo "$result"
}

section() { echo -e "\n${BOLD}${CYAN}━━━ $1 ━━━${NC}"; }
check_pass() { echo -e "  ${GREEN}✓${NC} $1"; }
check_fail() { echo -e "  ${RED}✗${NC} $1"; }
check_warn() { echo -e "  ${YELLOW}⚠${NC} $1"; }
check_info() { echo -e "  ${BLUE}ℹ${NC} $1"; }

add_critical() { CRITICAL_ISSUES+=("$1"); SCORE=$((SCORE - 20)); }
add_high() { HIGH_ISSUES+=("$1"); SCORE=$((SCORE - 10)); }
add_medium() { MEDIUM_ISSUES+=("$1"); SCORE=$((SCORE - 5)); }
add_low() { LOW_ISSUES+=("$1"); SCORE=$((SCORE - 2)); }

echo -e "${BOLD}${MAGENTA}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}${MAGENTA}║     🌐 NGINX AUDIT v5.2 [FIXED] - $(date '+%Y-%m-%d %H:%M:%S')                 ║${NC}"
echo -e "${BOLD}${MAGENTA}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"

section "1. CONNECTIVITY"
PROD_OK=$(ssh_prod "echo OK" 30)
STAGING_OK=$(ssh_staging "echo OK" 30)
[ "$PROD_OK" = "OK" ] && { check_pass "Production: connected"; PROD_CONN=true; } || { check_fail "Production: failed"; add_critical "SSH failed"; PROD_CONN=false; }
[ "$STAGING_OK" = "OK" ] && { check_pass "Staging: connected"; STAGING_CONN=true; } || { STAGING_CONN=false; }

section "2-10. NGINX SERVICE & CONFIGURATION"
if [ "$PROD_CONN" = true ]; then
    NGINX_STATUS=$(ssh_prod 'systemctl is-active nginx' 5 | tr -d '\r\n' | xargs)
    NGINX_VER=$(ssh_prod 'nginx -v 2>&1 | grep -oP "\\d+\\.\\d+\\.\\d+"' 5 | tr -d '\r\n' | xargs)
    CONFIG_TEST=$(ssh_prod 'sudo nginx -t 2>&1 | tail -1' 5 | tr -d '\r')
    WORKER_PROC=$(ssh_prod 'grep "worker_processes" /etc/nginx/nginx.conf 2>/dev/null | head -1' 5 | tr -d '\r')
    WORKER_CONN=$(ssh_prod 'grep "worker_connections" /etc/nginx/nginx.conf 2>/dev/null | head -1' 5 | tr -d '\r')
    GZIP=$(ssh_prod 'grep -r "gzip on" /etc/nginx/ 2>/dev/null | head -1' 5 | tr -d '\r')
    SSL_PROTO=$(ssh_prod 'grep -r "ssl_protocols" /etc/nginx/ 2>/dev/null | head -1' 5 | tr -d '\r')
    SITES=$(ssh_prod 'ls /etc/nginx/sites-enabled/ 2>/dev/null | head -5' 5)
    VHOSTS_COUNT=$(ssh_prod 'ls /etc/nginx/sites-enabled/ 2>/dev/null | wc -l' 5 | tr -d '\r\n' | xargs)
    HTTP2=$(ssh_prod 'grep -r "http2" /etc/nginx/sites-enabled/ 2>/dev/null | head -1' 5 | tr -d '\r')
    SEC_HEADERS=$(ssh_prod 'grep -rE "X-Frame-Options|X-Content-Type|X-XSS" /etc/nginx/sites-enabled/ 2>/dev/null | wc -l' 5 | tr -d '\r\n' | xargs)
    CACHE=$(ssh_prod 'grep -r "add_header.*Cache-Control" /etc/nginx/sites-enabled/ 2>/dev/null | head -1' 5 | tr -d '\r')
    ERR_SIZE=$(ssh_prod 'du -sh /var/log/nginx/error.log 2>/dev/null | cut -f1' 5 | tr -d '\r\n' | xargs)
    ACC_SIZE=$(ssh_prod 'du -sh /var/log/nginx/access.log 2>/dev/null | cut -f1' 5 | tr -d '\r\n' | xargs)
    RECENT_ERRORS=$(ssh_prod 'tail -10 /var/log/nginx/error.log 2>/dev/null | grep -i error | tail -3' 5)
    COUNT_404=$(ssh_prod 'grep -c " 404 " /var/log/nginx/access.log 2>/dev/null' 5 | tr -d '\r\n' | xargs)
    COUNT_500=$(ssh_prod 'grep -c " 500 " /var/log/nginx/access.log 2>/dev/null' 5 | tr -d '\r\n' | xargs)
    CERTBOT=$(ssh_prod 'systemctl is-active certbot.timer 2>/dev/null' 5 | tr -d '\r\n' | xargs)

    echo -e "${CYAN}Service:${NC}"
    [ "$NGINX_STATUS" = "active" ] && check_pass "Nginx: active (v$NGINX_VER)" || { check_fail "Nginx: $NGINX_STATUS"; add_critical "Nginx not running"; }
    echo "$CONFIG_TEST" | grep -qi "successful" && check_pass "Config test: passed" || { check_warn "Config test: $CONFIG_TEST"; add_high "Nginx config error"; }

    echo -e "\n${CYAN}Configuration:${NC}"
    check_info "Worker processes: $WORKER_PROC"
    check_info "Worker connections: $WORKER_CONN"
    [ -n "$GZIP" ] && check_pass "Gzip: enabled" || { check_warn "Gzip: not enabled"; add_medium "Enable gzip"; }

    echo -e "\n${CYAN}Virtual Hosts ($VHOSTS_COUNT):${NC}"
    echo "$SITES" | while read -r site; do [ -n "$site" ] && check_info "$site"; done

    echo -e "\n${CYAN}SSL/TLS:${NC}"
    [ -n "$SSL_PROTO" ] && check_info "SSL: $SSL_PROTO"
    [ -n "$HTTP2" ] && check_pass "HTTP/2: enabled" || check_info "HTTP/2: not detected"
    [ "$CERTBOT" = "active" ] && check_pass "Certbot timer: active" || check_info "Certbot: $CERTBOT"

    echo -e "\n${CYAN}Security Headers:${NC}"
    [ "${SEC_HEADERS:-0}" -ge 2 ] 2>/dev/null && check_pass "Security headers: $SEC_HEADERS configured" || { check_warn "Security headers: $SEC_HEADERS"; add_medium "Add security headers"; }
    [ -n "$CACHE" ] && check_pass "Cache-Control: configured" || check_info "Cache-Control: not found"

    echo -e "\n${CYAN}Logs:${NC}"
    check_info "Error log: $ERR_SIZE | Access log: $ACC_SIZE"
    [ "${COUNT_404:-0}" -gt 500 ] 2>/dev/null && { check_warn "404 errors: $COUNT_404"; add_low "Many 404 errors"; } || check_pass "404 errors: ${COUNT_404:-0}"
    [ "${COUNT_500:-0}" -gt 10 ] 2>/dev/null && { check_warn "500 errors: $COUNT_500"; add_high "Server errors detected"; } || check_pass "500 errors: ${COUNT_500:-0}"

    if [ -n "$RECENT_ERRORS" ]; then
        check_warn "Recent errors:"
        echo "$RECENT_ERRORS" | head -2 | while read -r line; do echo "    $line"; done
    fi
fi

section "11-13. STAGING NGINX"
if [ "$STAGING_CONN" = true ]; then
    STG_STATUS=$(ssh_staging 'systemctl is-active nginx' 5 | tr -d '\r\n' | xargs)
    STG_VER=$(ssh_staging 'nginx -v 2>&1 | grep -oP "\\d+\\.\\d+\\.\\d+"' 5 | tr -d '\r\n' | xargs)
    STG_CONFIG=$(ssh_staging 'sudo nginx -t 2>&1 | tail -1' 5 | tr -d '\r')
    STG_VHOSTS=$(ssh_staging 'ls /etc/nginx/sites-enabled/ 2>/dev/null | wc -l' 5 | tr -d '\r\n' | xargs)

    [ "$STG_STATUS" = "active" ] && check_pass "Staging Nginx: active (v$STG_VER)" || check_warn "Staging Nginx: $STG_STATUS"
    echo "$STG_CONFIG" | grep -qi "successful" && check_pass "Staging config: passed" || check_warn "Staging config: $STG_CONFIG"
    check_info "Staging vhosts: $STG_VHOSTS"
fi

section "14. COMPARISON"
echo -e "  ${BOLD}Metric              Production    Staging${NC}"
echo -e "  ─────────────────────────────────────────────"
printf "  %-18s %-13s %s\n" "Status" "${NGINX_STATUS:-?}" "${STG_STATUS:-?}"
printf "  %-18s %-13s %s\n" "Version" "${NGINX_VER:-?}" "${STG_VER:-?}"
printf "  %-18s %-13s %s\n" "Vhosts" "${VHOSTS_COUNT:-?}" "${STG_VHOSTS:-?}"

section "🔴 THINGS TO FIX"
if [[ ${#CRITICAL_ISSUES[@]} -gt 0 || ${#HIGH_ISSUES[@]} -gt 0 || ${#MEDIUM_ISSUES[@]} -gt 0 || ${#LOW_ISSUES[@]} -gt 0 ]]; then
    echo -e "${BOLD}${RED}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}${RED}║              🔴 THINGS TO FIX - NGINX                         ║${NC}"
    echo -e "${BOLD}${RED}╚═══════════════════════════════════════════════════════════════╝${NC}"
    for issue in "${CRITICAL_ISSUES[@]}"; do echo -e "  ${RED}🔴 CRITICAL: $issue${NC}"; done
    for issue in "${HIGH_ISSUES[@]}"; do echo -e "  ${RED}🟠 HIGH: $issue${NC}"; done
    for issue in "${MEDIUM_ISSUES[@]}"; do echo -e "  ${YELLOW}🟡 MEDIUM: $issue${NC}"; done
    for issue in "${LOW_ISSUES[@]}"; do echo -e "  ${BLUE}🔵 LOW: $issue${NC}"; done
else
    echo -e "  ${GREEN}✓ No issues found! Nginx is healthy.${NC}"
fi

section "FINAL SUMMARY"
DUR=$(($(date +%s) - SCRIPT_START))
[[ $SCORE -lt 0 ]] && SCORE=0

if [[ $SCORE -ge 90 ]]; then RATING="EXCELLENT"; COLOR="$GREEN"
elif [[ $SCORE -ge 75 ]]; then RATING="GOOD"; COLOR="$GREEN"
elif [[ $SCORE -ge 60 ]]; then RATING="FAIR"; COLOR="$YELLOW"
else RATING="NEEDS WORK"; COLOR="$YELLOW"; fi

echo -e "\n${BOLD}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}║  Critical: ${RED}${#CRITICAL_ISSUES[@]}${NC}${BOLD}  High: ${YELLOW}${#HIGH_ISSUES[@]}${NC}${BOLD}  Medium: ${YELLOW}${#MEDIUM_ISSUES[@]}${NC}${BOLD}  Low: ${BLUE}${#LOW_ISSUES[@]}${NC}${BOLD}      ║${NC}"
printf "${BOLD}║  NGINX_SCORE: ${COLOR}%3d/100${NC} ${BOLD}[${COLOR}%-17s${NC}${BOLD}]  Time: %3ds     ║${NC}\n" "$SCORE" "$RATING" "$DUR"
echo -e "${BOLD}╚══════════════════════════════════════════════════════════════╝${NC}"
echo "NGINX_SCORE:$SCORE"
