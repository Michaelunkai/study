name: Frontend CI/CD (50+ ULTIMATE Steps)
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 45
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for author tracking

    - name: ğŸ“‹ Generate Deployment Change Summary
      run: |
        # Determine environment based on branch
        BRANCH="${{ github.ref_name }}"
        ENV_NAME="STAGING"
        if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          ENV_NAME="PRODUCTION"
        fi

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“‹ DEPLOYMENT CHANGE SUMMARY - TovPlay Frontend ${ENV_NAME}                  â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸŒ Environment: ${ENV_NAME}"
        echo "ğŸŒ¿ Branch: ${BRANCH}"
        echo "ğŸ“Œ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Deployer: ${{ github.actor }}"
        echo "ğŸ•’ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“ CURRENT COMMIT MESSAGE                                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        git log -1 --pretty=format:"%B"
        echo ""
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“š COMMIT HISTORY (Last 5 commits)                                     â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        git log HEAD~5..HEAD --pretty=format:"[%h] %an <%ae> - %ar%n    %s%n" 2>/dev/null || git log -5 --pretty=format:"[%h] %an <%ae> - %ar%n    %s%n"
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ‘¥ TEAM MEMBER CONTRIBUTIONS (This deployment period)                  â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        git log HEAD~5..HEAD --format='%an <%ae>' 2>/dev/null | sort | uniq -c | sort -rn || echo "No commit history available"
        echo ""

        # Calculate statistics
        ADDED=$(git diff HEAD~1 HEAD --numstat 2>/dev/null | awk '{add+=$1} END {print add+0}')
        DELETED=$(git diff HEAD~1 HEAD --numstat 2>/dev/null | awk '{del+=$2} END {print del+0}')
        FILES=$(git diff HEAD~1 HEAD --name-only 2>/dev/null | wc -l)
        NET=$((ADDED - DELETED))

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“Š CHANGE STATISTICS                                                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        if [ $NET -lt 0 ]; then
          echo "ğŸ“‰ Net Change: Refactor/Cleanup - ${NET} lines removed"
        else
          echo "ğŸ“ˆ Net Change: Addition - +${NET} lines added"
        fi
        echo "ğŸ“ Files Changed: ${FILES}"
        echo "â• Lines Added: +${ADDED}"
        echo "â– Lines Deleted: -${DELETED}"
        echo "ğŸ”¢ Net Change: ${NET} lines"
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“‚ DETAILED FILE CHANGES WITH IMPACT ANALYSIS                          â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        git diff --name-status HEAD~1 HEAD 2>/dev/null | while IFS=$'\t' read -r status file rest; do
          if [ -z "$file" ]; then continue; fi

          # Handle renamed files
          OLD_FILE=""
          NEW_FILE="$file"
          if [[ "$status" =~ ^R ]]; then
            OLD_FILE="$file"
            NEW_FILE="$rest"
            file="$NEW_FILE"
          fi

          # Get file statistics
          LINE_STATS=$(git diff HEAD~1 HEAD --numstat -- "$file" 2>/dev/null | awk '{
            if ($1 == "-" && $2 == "-") {
              print "BINARY"
            } else {
              print "+" $1 " -" $2
            }
          }')
          [ -z "$LINE_STATS" ] && LINE_STATS="+0 -0"

          # Determine change type
          CHANGE_TYPE=""
          case "$status" in
            A) CHANGE_TYPE="âœ… ADDED" ;;
            M) CHANGE_TYPE="âœï¸  MODIFIED" ;;
            D) CHANGE_TYPE="âŒ DELETED" ;;
            R100) CHANGE_TYPE="ğŸ“¦ RENAMED (no changes)" ;;
            R*) CHANGE_TYPE="ğŸ“¦âœï¸  RENAMED + MODIFIED" ;;
            C*) CHANGE_TYPE="ğŸ“‹ COPIED" ;;
            *) CHANGE_TYPE="ğŸ”„ $status" ;;
          esac

          # Impact analysis based on file type
          IMPACT=""
          case "$file" in
            # Core application files
            *src/main.jsx|*src/App.jsx)
              IMPACT="âš ï¸  CRITICAL - App entry point, affects entire application startup"
              ;;
            # API layer
            *src/api/*)
              IMPACT="ğŸ”Œ HIGH - Backend communication layer, may affect data flow"
              ;;
            # Pages (routing)
            *src/pages/Dashboard*)
              IMPACT="ğŸ“Š HIGH - Main dashboard, affects primary user experience"
              ;;
            *src/pages/Profile*)
              IMPACT="ğŸ‘¤ MEDIUM - User profile page"
              ;;
            *src/pages/SignIn*|*src/pages/CreateAccount*|*src/pages/VerifyOTP*)
              IMPACT="ğŸ” CRITICAL - Authentication flow, test login/signup carefully"
              ;;
            *src/pages/FindPlayers*)
              IMPACT="ğŸ® HIGH - Matchmaking feature"
              ;;
            *src/pages/Schedule*|*src/pages/OnboardingSchedule*)
              IMPACT="ğŸ“… MEDIUM - Availability scheduling"
              ;;
            *src/pages/*)
              IMPACT="ğŸ“„ MEDIUM - User-facing page/route"
              ;;
            # Components
            *src/components/ui/*)
              IMPACT="ğŸ¨ LOW - Reusable UI component (may affect multiple pages)"
              ;;
            *src/components/system/*)
              IMPACT="âš™ï¸  MEDIUM - System component (monitoring, health checks)"
              ;;
            *src/components/*)
              IMPACT="ğŸ§© MEDIUM - Shared component"
              ;;
            # State management
            *src/stores/*)
              IMPACT="ğŸ—„ï¸  HIGH - Global state management, affects data flow across app"
              ;;
            *src/context/*)
              IMPACT="ğŸ”— HIGH - React context provider, affects dependent components"
              ;;
            # Utilities and hooks
            *src/utils/*)
              IMPACT="ğŸ”§ MEDIUM - Helper utilities, check usages"
              ;;
            *src/hooks/*)
              IMPACT="ğŸª MEDIUM - Custom React hooks, verify dependent components"
              ;;
            *src/lib/*)
              IMPACT="ğŸ“š MEDIUM - Shared libraries"
              ;;
            # Configuration files
            *vite.config*)
              IMPACT="âš ï¸  CRITICAL - Vite bundler config, may affect build process"
              ;;
            *package.json)
              IMPACT="âš ï¸  CRITICAL - NPM dependencies, verify compatibility"
              ;;
            *package-lock.json)
              IMPACT="ğŸ”’ HIGH - Dependency lock file, run 'npm ci' to sync"
              ;;
            *.env*)
              IMPACT="âš ï¸  CRITICAL - Environment variables, verify all required vars are set"
              ;;
            *tsconfig*)
              IMPACT="ğŸ“˜ MEDIUM - TypeScript configuration"
              ;;
            *docker*|*Dockerfile*)
              IMPACT="ğŸ³ HIGH - Container configuration, may require image rebuild"
              ;;
            *.github/workflows/*)
              IMPACT="âš ï¸  CRITICAL - CI/CD pipeline, this workflow itself was modified"
              ;;
            # Tests
            *test*|*spec*|*.test.*)
              IMPACT="âœ… LOW - Automated tests"
              ;;
            # Assets and styles
            *.css|*.scss|*.sass)
              IMPACT="ğŸ¨ LOW - Styling changes"
              ;;
            *.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico)
              IMPACT="ğŸ–¼ï¸  LOW - Image assets"
              ;;
            *)
              IMPACT="â„¹ï¸  INFO - General file change"
              ;;
          esac

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "${CHANGE_TYPE}: $file"
          echo "   ğŸ“ Changes: ${LINE_STATS}"
          echo "   ${IMPACT}"

          # Show rename info if applicable
          if [ -n "$OLD_FILE" ] && [ "$OLD_FILE" != "$NEW_FILE" ]; then
            echo "   ğŸ“¦ Renamed from: $OLD_FILE"
          fi

          # Show actual code diff for critical files
          if [[ "$file" =~ (main\.jsx|App\.jsx|vite\.config|package\.json|\.env|Dockerfile|workflows) ]]; then
            echo "   ğŸ“„ Code diff (first 30 lines):"
            git diff HEAD~1 HEAD -- "$file" 2>/dev/null | head -30 | sed 's/^/      /'
          fi

          echo ""
        done

        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“¦ NPM DEPENDENCY COMPARISON                                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -q "package.json"; then
          echo "âš ï¸  package.json was modified - Dependency changes detected:"
          echo ""
          echo "BEFORE (HEAD~1):"
          git show HEAD~1:package.json 2>/dev/null | grep -A 999 '"dependencies"' | head -50 || echo "  Unable to retrieve previous package.json"
          echo ""
          echo "AFTER (HEAD):"
          cat package.json 2>/dev/null | grep -A 999 '"dependencies"' | head -50 || echo "  Unable to retrieve current package.json"
          echo ""
          echo "ğŸ” DEPENDENCY DIFF:"
          git diff HEAD~1 HEAD -- package.json 2>/dev/null | grep -E '^\+.*"|^\-.*"' | sed 's/^/  /'
        else
          echo "âœ… No dependency changes in this deployment"
        fi
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“Š FILE STATISTICS SUMMARY                                             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        git diff --stat HEAD~1 HEAD 2>/dev/null || echo "No changes detected"
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âš ï¸  CRITICAL CHANGES & BREAKING CHANGE DETECTION                       â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        CRITICAL=0
        BREAKING=0

        # Check for breaking changes in commit messages
        if git log -1 --pretty=format:"%B" | grep -qiE "breaking|break:|BREAKING CHANGE"; then
          echo "ğŸš¨ BREAKING CHANGE DETECTED IN COMMIT MESSAGE"
          echo "   Review commit message above for breaking change details"
          BREAKING=1
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "package\.json|package-lock\.json"; then
          echo "ğŸ“¦ NPM DEPENDENCIES CHANGED"
          echo "   Files modified:"
          git diff HEAD~1 HEAD --name-only | grep -E "package\.json|package-lock\.json" | sed 's/^/      /'
          echo "   âš ï¸  Action required: Run 'npm ci' or 'npm install' to sync dependencies"
          echo "   âš ï¸  Review compatibility and test thoroughly before deployment"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "\.env|vite\.config|tsconfig"; then
          echo "ğŸ” BUILD/CONFIG FILES CHANGED"
          git diff HEAD~1 HEAD --name-only | grep -E "\.env|vite\.config|tsconfig" | sed 's/^/      /'
          echo "   âš ï¸  Verify all environment variables are correctly set"
          echo "   âš ï¸  Build configuration may have changed - test build process"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "docker|Dockerfile"; then
          echo "ğŸ³ DOCKER CONFIGURATION CHANGED"
          git diff HEAD~1 HEAD --name-only | grep -E "docker|Dockerfile" | sed 's/^/      /'
          echo "   âš ï¸  Container image needs to be rebuilt"
          echo "   âš ï¸  Verify Docker build succeeds before deployment"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "auth|login|security|jwt|oauth|SignIn|CreateAccount|VerifyOTP"; then
          echo "ğŸ”’ AUTHENTICATION/SECURITY CHANGES DETECTED"
          git diff HEAD~1 HEAD --name-only | grep -E "auth|login|security|jwt|oauth|SignIn|CreateAccount|VerifyOTP" | sed 's/^/      /'
          echo "   âš ï¸  CRITICAL: Test complete authentication flow"
          echo "   âš ï¸  Verify: Login, Signup, OTP verification, Password reset"
          echo "   âš ï¸  Check: JWT token generation, OAuth flows, Session management"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "src/stores|src/context"; then
          echo "ğŸ—„ï¸  STATE MANAGEMENT CHANGES"
          git diff HEAD~1 HEAD --name-only | grep -E "src/stores|src/context" | sed 's/^/      /'
          echo "   âš ï¸  Global state or context modified - may affect multiple components"
          echo "   âš ï¸  Test data flow and state persistence across the app"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "src/api"; then
          echo "ğŸ”Œ API LAYER CHANGES"
          git diff HEAD~1 HEAD --name-only | grep -E "src/api" | sed 's/^/      /'
          echo "   âš ï¸  Backend communication layer modified"
          echo "   âš ï¸  Verify API endpoints and data contracts still match backend"
          CRITICAL=1
        fi

        if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "\.github/workflows"; then
          echo "ğŸ”„ CI/CD PIPELINE MODIFIED"
          git diff HEAD~1 HEAD --name-only | grep -E "\.github/workflows" | sed 's/^/      /'
          echo "   âš ï¸  This deployment workflow itself was changed"
          echo "   âš ï¸  Monitor this deployment run carefully for issues"
          CRITICAL=1
        fi

        if [ $CRITICAL -eq 0 ]; then
          echo "âœ… No critical changes detected - Deployment appears safe"
          echo "   Standard testing procedures apply"
        fi
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ”„ ROLLBACK INSTRUCTIONS (If deployment fails)                         â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        PREVIOUS_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "unknown")
        PREVIOUS_AUTHOR=$(git log -1 HEAD~1 --pretty=format:"%an <%ae>" 2>/dev/null || echo "unknown")
        PREVIOUS_MESSAGE=$(git log -1 HEAD~1 --pretty=format:"%s" 2>/dev/null || echo "unknown")

        echo "ğŸ“Œ Previous stable commit: ${PREVIOUS_COMMIT}"
        echo "ğŸ‘¤ Previous commit author: ${PREVIOUS_AUTHOR}"
        echo "ğŸ’¬ Previous commit message: ${PREVIOUS_MESSAGE}"
        echo ""
        echo "To rollback manually:"
        echo "   git revert ${{ github.sha }}"
        echo "   # OR force rollback (use with caution):"
        echo "   git reset --hard ${PREVIOUS_COMMIT}"
        echo "   git push --force"
        echo ""
        echo "To rollback via GitHub Actions:"
        echo "   Re-run the previous successful workflow deployment"
        echo "   Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions"
        echo ""

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… DEPLOYMENT SUMMARY COMPLETE                                         â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ¯ Environment: ${ENV_NAME}"
        echo "ğŸš€ Ready to proceed with deployment to ${ENV_NAME}"
        echo "ğŸ“Š Total changes: ${FILES} files, ${NET} net lines"
        if [ $BREAKING -eq 1 ]; then
          echo "ğŸš¨ BREAKING CHANGES PRESENT - Exercise extreme caution"
        fi
        if [ $CRITICAL -eq 1 ]; then
          echo "âš ï¸  CRITICAL CHANGES DETECTED - Review above warnings carefully"
        fi
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Clean install dependencies
      run: |
        rm -rf node_modules package-lock.json npm-shrinkwrap.json
        npm install --force
      timeout-minutes: 10
      env:
        npm_config_platform: linux
        npm_config_arch: x64
    - name: Build application for production
      run: npm run build
      timeout-minutes: 10
      env:
        VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID || '' }}
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:5000' }}
    - uses: docker/setup-buildx-action@v3
    - uses: docker/login-action@v3
      with:
        username: tovtech
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - id: env
      run: |
        if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "tag=latest" >> $GITHUB_OUTPUT
          echo "env=production" >> $GITHUB_OUTPUT
        else
          echo "tag=staging" >> $GITHUB_OUTPUT
          echo "env=staging" >> $GITHUB_OUTPUT
        fi
    - uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: tovtech/tovplayfrontend:${{ steps.env.outputs.tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      timeout-minutes: 15
    - name: Deploy to Staging
      if: steps.env.outputs.env == 'staging'
      uses: appleboy/ssh-action@v1.0.3
      timeout-minutes: 10
      with:
        host: 92.113.144.59
        username: admin
        password: 3897ysdkjhHH
        port: 22
        timeout: 300s
        command_timeout: 300s
        script: |
          cd /home/admin/tovplay
          echo "=== Pulling new frontend image ==="
          docker pull tovtech/tovplayfrontend:staging
          echo "=== Extracting static files ==="
          docker rm -f frontend-temp 2>/dev/null || true
          docker create --name frontend-temp tovtech/tovplayfrontend:staging
          sudo rm -rf /tmp/frontend-deploy
          mkdir -p /tmp/frontend-deploy
          docker cp frontend-temp:/usr/share/nginx/html/. /tmp/frontend-deploy/
          docker rm frontend-temp
          sudo rsync -a --delete /tmp/frontend-deploy/ /var/www/tovplay-staging/
          rm -rf /tmp/frontend-deploy
          echo "=== STAGING FRONTEND DEPLOYED ==="
    - name: Deploy to Production
      if: steps.env.outputs.env == 'production'
      uses: appleboy/ssh-action@v1.0.3
      timeout-minutes: 10
      with:
        host: 193.181.213.220
        username: admin
        password: EbTyNkfJG6LM
        port: 22
        timeout: 300s
        command_timeout: 300s
        script: |
          cd /home/admin/tovplay
          echo "=== Pulling new frontend image ==="
          docker pull tovtech/tovplayfrontend:latest
          echo "=== Force removing old frontend containers ==="
          docker stop tovplay-frontend-production 2>/dev/null || true
          docker stop tovplay-frontend 2>/dev/null || true
          docker rm -f tovplay-frontend-production 2>/dev/null || true
          docker rm -f tovplay-frontend 2>/dev/null || true
          echo "=== Starting new frontend container ==="
          docker compose -f docker-compose.production.yml up -d --force-recreate --remove-orphans frontend || docker-compose -f docker-compose.production.yml up -d --force-recreate --remove-orphans frontend || true
          sleep 10
          echo "=== Container status ==="
          docker ps -a | grep -E "frontend|production" || true
          echo "=== PRODUCTION FRONTEND DEPLOYED ==="
    - run: echo "âœ… DEPLOYMENT COMPLETE - ${{ steps.env.outputs.env }}"
