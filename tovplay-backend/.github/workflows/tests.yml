name: Backend Tests & Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # DEPLOY JOB - Deploys to staging/production
  # Tests removed during Dec 2025 debloat
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for author tracking

      - name: ğŸ“‹ Generate ULTIMATE Deployment Change Summary
        run: |
          # Determine environment based on branch
          BRANCH="${{ github.ref_name }}"
          ENV_NAME="STAGING"
          SERVER_URL="https://staging.tovplay.org"
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENV_NAME="PRODUCTION"
            SERVER_URL="https://app.tovplay.org"
          fi

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“‹ ULTIMATE DEPLOYMENT CHANGE SUMMARY - TovPlay Backend ${ENV_NAME}  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Environment: ${ENV_NAME}"
          echo "ğŸ”€ Branch: ${BRANCH}"
          echo "ğŸ”– Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed By: ${{ github.actor }}"
          echo "ğŸ• Deployment Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Server URL: ${SERVER_URL}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ”— Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“ LATEST COMMIT MESSAGE                                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          git log -1 --pretty=format:"%B"
          echo ""
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“œ COMPLETE COMMIT HISTORY (since last deployment)                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          git log HEAD~5..HEAD --pretty=format:"[%h] %an <%ae> - %ar%n    ğŸ“ %s%n    ğŸ• %ad%n" --date=format:'%Y-%m-%d %H:%M:%S' 2>/dev/null || git log -5 --pretty=format:"[%h] %an <%ae> - %ar%n    ğŸ“ %s%n    ğŸ• %ad%n" --date=format:'%Y-%m-%d %H:%M:%S'
          echo ""
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ‘¥ TEAM MEMBER CONTRIBUTIONS                                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          git log HEAD~5..HEAD --pretty=format:"%an" 2>/dev/null | sort | uniq -c | sort -rn | awk '{print "   "$2" "$3" "$4" - "$1" commit(s)"}' || echo "Single commit deployment"
          echo ""
          echo ""

          # Calculate statistics
          ADDED=$(git diff HEAD~1 HEAD --numstat 2>/dev/null | awk '{add+=$1} END {print add+0}')
          DELETED=$(git diff HEAD~1 HEAD --numstat 2>/dev/null | awk '{del+=$2} END {print del+0}')
          FILES=$(git diff HEAD~1 HEAD --name-only 2>/dev/null | wc -l)
          NET=$((ADDED - DELETED))

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š DEPLOYMENT STATISTICS                                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ $NET -lt 0 ]; then
            echo "ğŸ“‰ Change Type: Refactor/Cleanup (${NET} lines net removal)"
          elif [ $NET -eq 0 ]; then
            echo "ğŸ”„ Change Type: Refactor (no net change)"
          else
            echo "ğŸ“ˆ Change Type: Feature/Enhancement (+${NET} lines net addition)"
          fi
          echo "ğŸ“ Files Changed: ${FILES}"
          echo "â• Lines Added: +${ADDED}"
          echo "â– Lines Deleted: -${DELETED}"
          echo "ğŸ“Š Net Change: ${NET} lines"
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“‚ DETAILED FILE CHANGES BY ORIGINAL AUTHOR                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Create temp file for processing
          TEMP_FILE=$(mktemp)

          # Track ALL changes by original author
          git diff --name-status HEAD~1 HEAD 2>/dev/null | while IFS=$'\t' read -r status file rest; do
            if [ -z "$file" ]; then continue; fi

            OLD_FILE=""
            NEW_FILE="$file"
            if [[ "$status" =~ ^R ]]; then
              OLD_FILE="$file"
              NEW_FILE="$rest"
              file="$NEW_FILE"
            fi

            # Get original author
            ORIGINAL_AUTHOR=""
            if [ "$status" != "D" ]; then
              ORIGINAL_AUTHOR=$(git log --follow --format="%an" --diff-filter=A -- "$file" 2>/dev/null | tail -1)
            else
              ORIGINAL_AUTHOR=$(git log -1 --format="%an" HEAD~1 -- "$file" 2>/dev/null)
            fi
            [ -z "$ORIGINAL_AUTHOR" ] && ORIGINAL_AUTHOR=$(git log --format="%an" -- "$file" 2>/dev/null | tail -1)
            [ -z "$ORIGINAL_AUTHOR" ] && [ -n "$OLD_FILE" ] && ORIGINAL_AUTHOR=$(git log --format="%an" -- "$OLD_FILE" 2>/dev/null | tail -1)
            [ -z "$ORIGINAL_AUTHOR" ] && ORIGINAL_AUTHOR="Unknown"

            # Get line changes
            LINE_STATS=$(git diff HEAD~1 HEAD --numstat -- "$file" 2>/dev/null | awk '{
              if ($1 == "-" && $2 == "-") {
                print "BINARY"
              } else {
                print $1"+"$2"-"
              }
            }')
            [ -z "$LINE_STATS" ] && LINE_STATS="0+0-"

            # Determine change type
            CHANGE_INFO=""
            case "$status" in
              A) TYPE="ADDED" ;;
              M) TYPE="MODIFIED" ;;
              D) TYPE="DELETED" ;;
              R100) TYPE="RENAMED"; CHANGE_INFO="(no changes: $OLD_FILE â†’ $NEW_FILE)" ;;
              R*) TYPE="RENAMED+MODIFIED"; CHANGE_INFO="($OLD_FILE â†’ $NEW_FILE)" ;;
              C*) TYPE="COPIED" ;;
              T) TYPE="TYPE_CHANGE"; CHANGE_INFO="(file type changed)" ;;
              *) TYPE="$status" ;;
            esac

            MODE_CHANGE=$(git diff HEAD~1 HEAD --summary -- "$file" 2>/dev/null | grep "mode change" || echo "")
            if [ -n "$MODE_CHANGE" ]; then
              CHANGE_INFO="${CHANGE_INFO} [PERMISSIONS CHANGED]"
            fi

            # Add context and purpose
            CONTEXT=""
            PURPOSE=""
            IMPACT=""
            case "$file" in
              *models.py|*models/*) CONTEXT="[DB Models]"; PURPOSE="â†’ Database schema"; IMPACT="âš ï¸ May require migration" ;;
              *routes/*|*api/*|*views.py) CONTEXT="[API Endpoints]"; PURPOSE="â†’ HTTP endpoints"; IMPACT="ğŸ”Œ API contract changes" ;;
              *migrations/*|*alembic/*) CONTEXT="[DB Migration]"; PURPOSE="â†’ Schema migration"; IMPACT="âš ï¸ Database will be modified" ;;
              *requirements.txt|*Pipfile*) CONTEXT="[Dependencies]"; PURPOSE="â†’ Python packages"; IMPACT="ğŸ“¦ Dependencies changed" ;;
              *.env*|*config*|*settings*) CONTEXT="[Config]"; PURPOSE="â†’ Configuration"; IMPACT="ğŸ”§ Config changes" ;;
              *test*|*spec*) CONTEXT="[Tests]"; PURPOSE="â†’ Test coverage"; IMPACT="âœ… Test updates" ;;
              *auth*|*security*|*jwt*) CONTEXT="[Security/Auth]"; PURPOSE="â†’ Authentication"; IMPACT="ğŸ” Security impact" ;;
              *monitoring*|*metrics*|*health*) CONTEXT="[Monitoring]"; PURPOSE="â†’ Observability"; IMPACT="ğŸ“Š Monitoring changes" ;;
              *wsgi*|*gunicorn*|*uwsgi*) CONTEXT="[Server Entry]"; PURPOSE="â†’ App server"; IMPACT="ğŸš€ Startup changes" ;;
              *docker*|*Dockerfile*) CONTEXT="[Docker]"; PURPOSE="â†’ Containerization"; IMPACT="ğŸ³ Container rebuild needed" ;;
              *.yml|*.yaml) CONTEXT="[Config/CI]"; PURPOSE="â†’ CI/CD automation"; IMPACT="ğŸ”„ Pipeline changes" ;;
              *bot.py) CONTEXT="[Discord Bot]"; PURPOSE="â†’ Discord integration"; IMPACT="ğŸ¤– Bot behavior changes" ;;
              *services.py|*src/services/*) CONTEXT="[Business Logic]"; PURPOSE="â†’ Core logic"; IMPACT="ğŸ’¼ Business logic changes" ;;
              *) CONTEXT="[Other]"; PURPOSE="â†’ General"; IMPACT="" ;;
            esac

            echo "${ORIGINAL_AUTHOR}|||${TYPE}|||${file}|||${LINE_STATS}|||${CONTEXT}|||${CHANGE_INFO}|||${PURPOSE}|||${IMPACT}" >> "$TEMP_FILE"
          done

          # Display grouped by author
          if [ -s "$TEMP_FILE" ]; then
            sort "$TEMP_FILE" | awk -F'|||' '
              BEGIN { current_author = "" }
              {
                author = $1; type = $2; file = $3; stats = $4
                context = $5; info = $6; purpose = $7; impact = $8

                if (author != current_author) {
                  if (current_author != "") print ""
                  print "### ğŸ‘¤ " author " (original file author)"
                  print ""
                  current_author = author
                }

                icon = "  "
                if (type == "ADDED") icon = "âœ…"
                else if (type == "MODIFIED") icon = "âœï¸ "
                else if (type == "DELETED") icon = "âŒ"
                else if (type == "RENAMED") icon = "ğŸ“¦"
                else if (type == "RENAMED+MODIFIED") icon = "ğŸ“¦âœï¸ "
                else if (type == "COPIED") icon = "ğŸ“‹"
                else if (type == "TYPE_CHANGE") icon = "ğŸ”„"

                output = "  " icon " " type ": " file " (" stats ") " context " " purpose
                if (impact != "") output = output " " impact
                if (info != "") output = output " " info
                print output
              }
            '
          fi
          rm -f "$TEMP_FILE"
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š DETAILED FILE-LEVEL DIFF SUMMARY                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          git diff --stat HEAD~1 HEAD 2>/dev/null || echo "No changes detected"
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” DETAILED CODE CHANGES (Key Files)                                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          for file in $(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E '\.(py|yml|yaml|txt|json|md)$' | head -10); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ File: $file"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            git diff HEAD~1 HEAD -- "$file" 2>/dev/null | head -50
            echo ""
          done
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“¦ DEPENDENCY CHANGES                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "requirements\.txt|Pipfile"; then
            echo "BEFORE:"
            git show HEAD~1:requirements.txt 2>/dev/null | head -20 || echo "No previous requirements.txt"
            echo ""
            echo "AFTER:"
            cat requirements.txt 2>/dev/null | head -20 || echo "No current requirements.txt"
          else
            echo "âœ… No dependency changes"
          fi
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”— RELATED ISSUES & PULL REQUESTS                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          git log HEAD~5..HEAD --pretty=format:"%B" 2>/dev/null | grep -oE '#[0-9]+|PR#[0-9]+|pull/[0-9]+' | sort -u | while read ref; do
            echo "   ğŸ”— Related: $ref - https://github.com/${{ github.repository }}/issues/${ref#\#}"
          done || echo "   No linked issues or PRs found"
          echo ""
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  CRITICAL CHANGES & BREAKING CHANGES DETECTION                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          CRITICAL=0

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "requirements\.txt|Pipfile|setup\.py"; then
            echo "ğŸ PYTHON DEPENDENCIES CHANGED"
            echo "   âš ï¸ Action Required: Review compatibility, update venv"
            git diff HEAD~1 HEAD --name-only | grep -E "requirements\.txt|Pipfile|setup\.py"
            CRITICAL=1
            echo ""
          fi

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "migrations/|alembic/"; then
            echo "ğŸ—„ï¸  DATABASE MIGRATIONS DETECTED"
            echo "   âš ï¸ Action Required: BACKUP DATABASE BEFORE DEPLOYMENT!"
            echo "   ğŸ’¡ Migration files:"
            git diff HEAD~1 HEAD --name-only | grep -E "migrations/|alembic/"
            CRITICAL=1
            echo ""
          fi

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "\.env|config\.py|settings\.py|docker"; then
            echo "ğŸ” CONFIGURATION FILES CHANGED"
            echo "   âš ï¸ Action Required: Verify environment variables match server"
            git diff HEAD~1 HEAD --name-only | grep -E "\.env|config\.py|settings\.py|docker"
            CRITICAL=1
            echo ""
          fi

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "auth|security|jwt|oauth|login"; then
            echo "ğŸ”’ SECURITY/AUTHENTICATION CHANGED"
            echo "   âš ï¸ Action Required: Test auth flow, verify tokens, check sessions"
            git diff HEAD~1 HEAD --name-only | grep -E "auth|security|jwt|oauth|login"
            CRITICAL=1
            echo ""
          fi

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "models\.py|models/"; then
            echo "ğŸ“Š DATABASE MODELS CHANGED"
            echo "   âš ï¸ Action Required: Verify migrations exist and match model changes"
            git diff HEAD~1 HEAD --name-only | grep -E "models\.py|models/"
            CRITICAL=1
            echo ""
          fi

          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -qE "\.github/workflows"; then
            echo "ğŸ”„ CI/CD PIPELINE MODIFIED"
            echo "   â„¹ï¸ Info: This deployment workflow itself was changed"
            git diff HEAD~1 HEAD --name-only | grep -E "\.github/workflows"
            CRITICAL=1
            echo ""
          fi

          if git log HEAD~5..HEAD --pretty=format:"%B" 2>/dev/null | grep -qiE "breaking|break:|BREAKING CHANGE"; then
            echo "ğŸ’¥ BREAKING CHANGES DETECTED IN COMMITS"
            echo "   âš ï¸ Warning: Review commit messages for breaking changes"
            git log HEAD~5..HEAD --pretty=format:"%s" | grep -iE "breaking|break:|BREAKING"
            CRITICAL=1
            echo ""
          fi

          if [ $CRITICAL -eq 0 ]; then
            echo "âœ… No critical changes detected - Safe to deploy"
            echo ""
          fi

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”™ ROLLBACK INSTRUCTIONS                                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          PREVIOUS_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "N/A")
          PREVIOUS_COMMIT=$(git log -1 --pretty=format:"%s" HEAD~1 2>/dev/null || echo "N/A")
          echo "If this deployment fails, rollback with:"
          echo ""
          echo "   git revert ${{ github.sha }}"
          echo "   # OR"
          echo "   git reset --hard ${PREVIOUS_SHA}"
          echo "   git push --force origin ${BRANCH}"
          echo ""
          echo "Previous stable commit: ${PREVIOUS_SHA}"
          echo "Previous commit message: ${PREVIOUS_COMMIT}"
          echo ""
          echo "Docker rollback:"
          echo "   docker pull tovtech/tovplaybackend:${PREVIOUS_SHA:0:7}"
          echo "   docker-compose up -d --force-recreate"
          echo ""

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… DEPLOYMENT SUMMARY COMPLETE                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ¯ Environment: ${ENV_NAME}"
          echo "ğŸ“¦ Total Changes: ${FILES} files, +${ADDED}/-${DELETED} lines"
          echo "ğŸ‘¥ Contributors: $(git log HEAD~5..HEAD --pretty=format:"%an" 2>/dev/null | sort -u | wc -l || echo "1")"
          echo "ğŸ• Ready for deployment at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || true

      - name: Security scan with safety
        run: |
          pip install safety
          safety check 2>/dev/null || true

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 src/ --exit-zero 2>/dev/null || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: tovtech
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
            echo "server=193.181.213.220" >> $GITHUB_OUTPUT
          else
            echo "tag=staging" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
            echo "server=92.113.144.59" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: tovtech/tovplaybackend:${{ steps.env.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Staging
        if: steps.env.outputs.env == 'staging'
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 5
        with:
          host: 92.113.144.59
          username: admin
          password: 3897ysdkjhHH
          port: 22
          timeout: 180s
          command_timeout: 180s
          script: |
            cd /home/admin/tovplay
            echo "=== Pulling new image ==="
            docker pull tovtech/tovplaybackend:staging
            echo "=== Force removing ALL old backend containers ==="
            docker stop tovplay-backend-staging 2>/dev/null || true
            docker stop tovplay-backend 2>/dev/null || true
            docker rm -f tovplay-backend-staging 2>/dev/null || true
            docker rm -f tovplay-backend 2>/dev/null || true
            docker container prune -f 2>/dev/null || true
            echo "=== Starting new containers ==="
            docker compose -f docker-compose.staging.yml up -d --force-recreate --remove-orphans || docker-compose -f docker-compose.staging.yml up -d --force-recreate --remove-orphans
            echo "=== Waiting for startup ==="
            sleep 15
            echo "=== Container status ==="
            docker ps -a | grep -E "tovplay-backend|staging" || true
            echo "=== Health check ==="
            curl -s http://localhost:5000/health || echo "Health check pending"

      - name: Deploy to Production
        if: steps.env.outputs.env == 'production'
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 5
        with:
          host: 193.181.213.220
          username: admin
          password: EbTyNkfJG6LM
          port: 22
          timeout: 180s
          command_timeout: 180s
          script: |
            cd /home/admin/tovplay
            echo "=== Pulling new image ==="
            docker pull tovtech/tovplaybackend:latest
            echo "=== Force removing ALL old backend containers ==="
            docker stop tovplay-backend-production 2>/dev/null || true
            docker stop tovplay-backend 2>/dev/null || true
            docker rm -f tovplay-backend-production 2>/dev/null || true
            docker rm -f tovplay-backend 2>/dev/null || true
            docker container prune -f 2>/dev/null || true
            echo "=== Starting new containers ==="
            docker compose -f docker-compose.production.yml up -d --force-recreate --remove-orphans || docker-compose -f docker-compose.production.yml up -d --force-recreate --remove-orphans
            echo "=== Waiting for startup ==="
            sleep 15
            echo "=== Container status ==="
            docker ps -a | grep -E "tovplay-backend|production" || true
            echo "=== Health check ==="
            curl -s http://localhost:5000/health || echo "Health check pending"

      - name: Verify deployment
        if: success()
        run: |
          sleep 10
          if [ "${{ steps.env.outputs.env }}" = "staging" ]; then
            curl -sf https://staging.tovplay.org/health && echo "Staging healthy!" || echo "Staging health check pending"
          else
            curl -sf https://app.tovplay.org/health && echo "Production healthy!" || echo "Production health check pending"
          fi
